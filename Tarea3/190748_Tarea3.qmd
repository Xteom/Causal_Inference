---
title: "Tarea 3: ENIGH Salud Alimentaria"
subtitle: "Inferencia Causal"
format: pdf
author: Mateo De La Roche Macías
editor: visual
echo: false #muesta código
include: true #muesta salida
---

```{r, include=FALSE}
library(reticulate)
use_condaenv(condaenv = "itam")
#install.packages(c("plm"))
library(dplyr)
library(ggplot2)
library(RCT)
library(sandwich)
library(lmtest)
library(stargazer)
library(plm)
library(tidyr)
```

Oregon tiene actualmente una lista de espera de 90,000 personas de bajos ingresos que buscan acceder a Medicaid, pero sólo dispone de 30,000 cupos disponibles. Adicionalmente, el estado carece de datos concretos para verificar si el acceso a Medicaid realmente tiene un impacto positivo en la salud autoreportada de los beneficiarios.

Vamos a realizar un análisis sobre los efectos del acceso al seguro de salud en la salud autoreportada. Los datos que se utilizan en el análisis fueron obtenidos mediante una lotería de selección aleatoría para asignar los cupos disponibles de Medicaid.

El estado de Oregon llevó a cabo la lotería, resultando en la selección aleatoria de 29,834 individuos de una lista inicial depurada de casi 75,000 solicitantes (los otros 15,000 solicitantes no eran elegibles para el programa).

Para evaluar el impacto del programa, se organizó una serie de encuestas en tres momentos clave: antes de la implementación del programa, a los seis meses (submuestra de 5000 individuos) y a los doce meses

needmet med Xm, ,health gen bin Xm, baddays phys Xm y baddays ment Xm

```{r}
oregon_0 <- read.csv("oregon_0.csv")
oregon_6 <- read.csv("oregon_6.csv")
oregon_12 <- read.csv("oregon_12.csv")
```

## Balances

### a) Verificación de aleatoriedad al asginar los grupos de tratamiento y control en datos basales.

***Tabla de balance para para datos antes de la implementación.***

En los datos tenemos como variables basales, año de nacimiento, género, ingresos del hogar, raza, educación.

```{r}
arrange(balance_table(oregon_0, "treatment"),(p_value1))
```

La tabla anterior plantea como hipótesis nula que no hay diferencia entre los grupos de tratamiento y control. Aunque la mayoría de las variables no parecen ser diferentes, el p-value en las variables `birthyear_list`, `female_list` y `hhinc_cat_0m` son menores a 0.05 lo cual nos permite concluir con un nivel de significancia del 0.05 que hubo un sesgo en la asignación de tratamiento. Parece ser que el año de nacimiento se utilizó como variable para asignar el tratamiento y que hubo un sesgo significativo otorgandole mayor tratamiento médico a las mujeres. Lo más preocupante es que el promedio de ingresos entre ambos grupos es significativamente muy diferente por lo que podría haber habido alguna especie de resago a la población con ingresos menores.

### b) Verificación de representatividad en submuestra y después de 12 meses

***Tabla de balance para para datos después de 6 meses.***

```{r}
arrange(balance_table(oregon_6, "treatment"),(p_value1))
```

Submuestra de 6 Meses: Hay diferencias significativas en varias variables, incluidas `baddays_ment_6m`, `baddays_phys_6m`, `health_gen_bin_6m`, `ins_any_6m` y `needmet_med_6m.` Esto sugiere que la submuestra de 6 meses puede no ser representativa del balance inicial, y podría haber sesgo en la asignación de tratamiento en esta submuestra. En especial se nota una gran diferencia en la variable `ins_any_6m`, la cual indica si tenía algún tipo de seguro, se puede ver como muchas personas del tratamiento si tenían seguro en comparación con las del grupo control.

***Tabla de balance para para datos después de 12 meses.***

```{r}
arrange(balance_table(oregon_12, "treatment"),(p_value1))
```

Aquí también se puede observar un sesgo, sin embargo, se observa un sesgo parecido al que se observa en la submuestra tomada a los 6 meses, esto quiere decir que lo más probable es que los encuestadores estén introduciendo alguna especie de sesgo al momento de encuestar.

### c) Efecto en representatividad

El uso de la muestra de seis meses puede afectar la representatividad de los resultados debido a los sesgos observados. Sin embargo, dado que estos sesgos también están presentes en la muestra de doce meses, esto sugiere que el diseño del estudio y los métodos de recolección de datos están introduciendo estos sesgos de manera sistemática. Es esencial ajustar los análisis subsecuentes para estas variables sesgadas para obtener estimaciones precisas del impacto del tratamiento.

## Efecto de tratamiento simple

### a) Definición de efectos

-   **Efecto Promedio del Tratamiento (ATE)**: El ATE es la diferencia promedio en los resultados entre aquellos que recibieron el tratamiento (acceso a Medicaid) y aquellos que no lo recibieron, en la población general. En este contexto, el ATE mide el impacto promedio de tener acceso a Medicaid en la salud general autoreportada de los beneficiarios, independientemente de si realmente usaron el servicio o no.

-   **Efecto Promedio en los Tratados (TOT)**: El TOT es la diferencia promedio en los resultados entre aquellos que recibieron el tratamiento (acceso a Medicaid) y aquellos que no lo recibieron, pero solo entre los individuos que realmente utilizaron el tratamiento. En este contexto, el TOT mide el impacto promedio de tener acceso a Medicaid en la salud general autoreportada de los beneficiarios que realmente utilizaron los servicios de Medicaid.

En este caso el *policy maker* se debería de fijar en el ATE ya que no solo le importan los beneficios propios del programa, si no también el beneficio que esté tiene sobre la población total (beneficio más externalidades). El TOT le interesaría más a los médicos o a Medicaid para tener el efecto de su programa.

### b) Evaluación del efecto de tratamiento utilizando el estimador de *Neyman*

*Prueba de Hipótesis*

-   $H_0$: El tratamiento (ganar la lotería) no tiene efecto sobre los beneficiarios ($ATE = 0$)
-   $H_1$: El tratamiento (ganar la lotería) tiene un efecto en la salud autoreportada de los beneficiarios $ATE \neq 0$

Definición de $ATE$: $$
ATE = \mathbb{E}[Y^T_i] - \mathbb{E}[Y^C_i]
$$ Donde:

-   $Y^T_i$: es el resultado potencial para el individuo $i$ sí recibe el tratamiento (pertence a $T$)
-   $Y^C_i$: es el resultado potencial para el individuo $i$ si no recibe el tratamiento (pertenece a $C$)

```{r}
# Estimador de Neyman
neyman_estimator <- function(data, outcome, treatment) {
  treated <- data[data[[treatment]] == 1, ]
  control <- data[data[[treatment]] == 0, ]
  
  ate <- mean(treated[[outcome]]) - mean(control[[outcome]])
  se <- sqrt(var(treated[[outcome]])/nrow(treated) + var(control[[outcome]])/nrow(control))
  t_stat <- ate / se
  p_value <- 2 * pt(-abs(t_stat), df = nrow(data) - 2)
  
  return(list(ATE = ate, SE = se, t_stat = t_stat, p_value = p_value))
}

# Calcular el estimador de Neyman
ney_results <- neyman_estimator(oregon_12, "health_gen_bin_12m", "treatment")
ney_results
```

Efecto Promedio del Tratamiento (ATE):

-   El ATE estimado es -0.0503. Esto significa que, en promedio, el grupo de tratamiento (los que ganaron la lotería de Medicaid) tiene una probabilidad 5.03% menor de reportar buena salud general (health_gen_bin_12m) en comparación con el grupo de control (los que no ganaron la lotería de Medicaid). Este resultado sugiere que el tratamiento tuvo un efecto negativo en la salud general autoreportada de los beneficiarios.

*Nota: El signo negativo es por como está construida la definición del ATE, no debería interpretarse como un efecto negativo.*

Error Estándar (SE):

-   El error estándar del ATE es 0.00735. Por lo tanto, la estimación es precisa.

Signficancia:

-   El P-value es de 8.53e-12, por lo cual podemos aceptar con un nivel de significancia de 0.001 (o hasta menor) que el efecto del tratamiento (ganar la lotería de Medicaid) sobre la salud general autoreportada doce meses después es estadísticamente significativo.

### c) Estimación OLS simple (sin controles) errores heterocedásticos

```{r}
model_ols_simple <- lm(health_gen_bin_12m ~ treatment, data = oregon_12)
```

Ecuación estimada:

```{r}
coeficientes <- coef(model_ols_simple)
cat("health_gen_bin_12m =", coeficientes[1], "+", coeficientes[2], "* treatment\n")
```

Resultados:

```{r}
coeftest(model_ols_simple, vcov = vcovHC(model_ols_simple, type = "HC1"))
```

El coeficiente del tratamiento representa el cambio en la probabilidad de reportar buena salud general asociado con ganar la lotería de Medicaid. La estimación es -0.0503, lo que indica que, en promedio, ganar la lotería de Medicaid reduce la probabilidad de reportar buena salud general en un 5.03%. Este resultado es estadísticamente significativo al nivel del 0.001. Esto concuerda con lo obtenido en la prueba de Neyman.

### d) Estimación OLS simple (con controles) errores heterocedásticos

```{r}
# Modelo OLS con controles
model_ols_controls <- lm(health_gen_bin_12m ~ treatment + birthyear_list + female_list + hhinc_cat_12m, data = oregon_12)

# Errores heterocedásticos
coeftest(model_ols_controls, vcov = vcovHC(model_ols_controls, type = "HC1"))
```

Los controles se eligieron basándonos en las variables que tenían sesgos al hacer las tablas de balance. Al utilizarlas como control podemos reducir el efecto que tienen y obtener un mejor $ATE$.

Al controlar por las variables sesgadas, podemos ver que el coeficiente del tratamiento disminuye, esto significa que que ganar la lotería de Medicaid reduce la probabilidad de reportar buena salud general en un 4.51% (sifnificativo con un significancia muy baja menor 0.001)

Para los coeficientes de las variables control:

-   Cada año adicional de edad está asociado con una reducción de 0.74% en la probabilidad de reportar buena salud general.
-   Ser mujer no tiene un efecto significativo en la probabilidad de reportar buena salud general. (nota al profesor, si fuera un reporte quitaría las variables no significativas y volvería a correr la regresión solo con controles significativos pero para no llenar de regresiones el inciso lo dejaré con los iniciales)
-   Un aumento en la categoría de ingresos del hogar está asociado con una reducción del 1.73% en la probabilidad de reportar buena salud general.

### e) Agregando el efecto de seis meses después como control

```{r}
# Modelo OLS con controles a los seis meses
model_ols_controls_6m <- lm(health_gen_bin_6m ~ treatment + birthyear_list + female_list + hhinc_cat_6m, data = oregon_6)

# Errores heterocedásticos
coeftest(model_ols_controls_6m, vcov = vcovHC(model_ols_controls_6m, type = "HC1"))
```

Es curioso observar que en el análisis a seis meses se ve un impacto marginalmente significativo en ser mujer, aunque no es altamente significativo (p-valor = 0.0647). Esto confirma que la forma en la que se realizó la submuestra podría no haber sido correcta. Sin embargo, el efecto del tratamiento a los seis meses (-5.11%) es consistente y no es muy diferente del efecto observado a los doce meses (-4.51%), lo que sugiere una robustez en la influencia del tratamiento sobre la salud general autoreportada.

### f) Reporte de resultados

```{r results='asis'}
# Generar la tabla de resultados
stargazer(model_ols_simple, model_ols_controls, model_ols_controls_6m, 
          type = "latex",
          dep.var.labels = c("Health General (12m)", "Health General (6m)"),
          covariate.labels = c("Treatment", "Year of Birth", "Female", "Household Income"),
          out = "results.txt")
```

El tamaño del efecto encontrado (-4.51% a los 12 meses y -5.11% a los 6 meses) es relativamente pequeño pero estadísticamente significativo. Esto puede considerarse un efecto moderado en el contexto de intervenciones de salud pública, donde cambios en la percepción de salud general pueden reflejar una combinación de múltiples factores. Con los controles, la $R^2$ mejora de forma significativa, lo que quiere decir que si explica mejor los datos.

## Primeras diferencias (dos periodos de tiempo)

```{r}
merged_data <- merge(oregon_0, oregon_12, by = "person_id", suffixes = c("_0m", "_12m"))

# Calcular las diferencias en las variables de interés
merged_data <- merged_data %>%
  mutate(diff_health_gen_bin = health_gen_bin_12m - health_gen_bin_0m,
         diff_treatment = treatment_12m - treatment_0m) 
```

### a) Análisis de primeras diferencias (datos basales y doce meses después)

```{r}
# Estimar el modelo de primeras diferencias con la variable de tratamiento original
model_diff <- lm(diff_health_gen_bin ~ treatment_0m, data = merged_data)
summary(model_diff)
```
El coeficiente del tratamiento nos indica que recibir el tratamiento esta relacionado con una mejor en la salud autoreportada de un `r round(unname(coef(model_diff)["treatment_0m"])*100,2)`% en comparación al grupo control (con significancia del 0.05). 

### b) Tabla de 2x2

```{r}
# Calcular las medias por grupo de tratamiento y control en el periodo basal
baseline_means <- oregon_0 %>%
  group_by(treatment) %>%
  summarize(mean_health_0m = mean(health_gen_bin_0m, na.rm = TRUE))

# Calcular las medias por grupo de tratamiento y control a los 12 meses
twelve_months_means <- oregon_12 %>%
  group_by(treatment) %>%
  summarize(mean_health_12m = mean(health_gen_bin_12m, na.rm = TRUE))

# Unir las medias en una sola tabla
means_table <- merge(baseline_means, twelve_months_means, by = "treatment", suffixes = c("_0m", "_12m"))

(means_table)
# Calcular el estimador de diferencias en diferencias
diff_in_diff = (means_table$mean_health_12m[2] - means_table$mean_health_0m[2]) - 
               (means_table$mean_health_12m[1] - means_table$mean_health_0m[1])

(diff_in_diff)
```
Cuando utilizamos diferencias en diferencias simple para calcular el efecto del tratamiento, obtenemos un valor de `r round(diff_in_diff*100,2)`%, el cual es mayor que cuando calculamos el efecto utilizando el modelo de primeras diferencias, que es `r round(unname(coef(model_diff)["treatment_0m"])*100,2)`%. Esto se debe a que, al utilizar el modelo de primeras diferencias, nos fijamos solo en el efecto de las personas que estaban presentes en ambos periodos. En el modelo de diferencias en diferencias simple, se incluyen todas las observaciones disponibles, independientemente de si los individuos están presentes en ambos periodos. Es posible que en este segundo modelo tengamos más personas que recibieron el tratamiento en el grupo de doce meses después, lo que hace que el efecto real se perciba mayor.

### c) Utilizando MCO.

$$
\Delta \text{Health Gen Bin} = \beta_0 + \beta_1 \text{Treatment} + \epsilon
$$

```{r}
model_diff_mco <- lm(diff_health_gen_bin ~ treatment_0m, data = merged_data)
summary(model_diff_mco)
```

Se cumple el mismo resultado (`r round(unname(coef(model_diff_mco)["treatment_0m"])*100,2)`%).

### d) Modelo de efectos fijos

```{r}
# Separar datos basales
baseline_data <- oregon_0 %>%
  mutate(time = 0)

# Separar datos de 12 meses
twelve_months_data <- oregon_12 %>%
  select(-ins_any_12m) %>%
  mutate(time = 1)

# Renombrar columnas para combinar adecuadamente
names(baseline_data) <- gsub("_0m", "", names(baseline_data))
names(twelve_months_data) <- gsub("_12m", "", names(twelve_months_data))

# Obtener IDs comunes en ambos conjuntos de datos
common_ids <- intersect(baseline_data$person_id, twelve_months_data$person_id)

# Filtrar datos basales y de 12 meses para incluir solo IDs comunes
baseline_data_filtered <- baseline_data %>%
  filter(person_id %in% common_ids)

twelve_months_data_filtered <- twelve_months_data %>%
  filter(person_id %in% common_ids)

# Combinar las dos bases de datos
combined_data <- bind_rows(baseline_data_filtered, twelve_months_data_filtered)

# Convertir los datos a formato panel
pdata <- pdata.frame(combined_data, index = c("person_id", "time"))
write.csv(pdata, file = "pdata.csv", row.names = FALSE)

#pdata <- read.csv("pdata.csv")

#model_fe <- plm(health_gen_bin ~ treatment, 
#                data = pdata, 
#                index = c("person_id", "time"),
#                model = "within")
#summary(model_fe)
```

```{python}
import pandas as pd
import numpy as np
import statsmodels.api as sm
from linearmodels.panel import PanelOLS

pdata = pd.read_csv("pdata.csv")

# Convertir a un DataFrame de panel
pdata = pdata.set_index(['person_id', 'time'])s

# Estimar el modelo de efectos fijos
mod = PanelOLS.from_formula('health_gen_bin ~ treatment + EntityEffects', pdata)
res = mod.fit(cov_type='clustered', cluster_entity=True, drop_absorbed=True)

# Mostrar los resultados del modelo
print(res.summary)


```




## Primeras diferencias (tres periodos de tiempo)

```{r}
oregon_0 <- read.csv("oregon_0.csv") %>% rename(health_gen_bin = health_gen_bin_0m)
oregon_6 <- read.csv("oregon_6.csv") %>% rename(health_gen_bin = health_gen_bin_6m)
oregon_12 <- read.csv("oregon_12.csv") %>% rename(health_gen_bin = health_gen_bin_12m)
# Añadir una columna 'time' para identificar los periodos
oregon_0$time <- 0
oregon_6$time <- 6
oregon_12$time <- 12

oregon_0 <- oregon_0 %>%
  select(person_id, treatment, health_gen_bin, time)

oregon_6 <- oregon_6 %>%
  select(person_id, treatment, health_gen_bin, time)

oregon_12 <- oregon_12 %>%
  select(person_id, treatment, health_gen_bin, time)
  

panel_data <- bind_rows(oregon_0, oregon_6, oregon_12)

# Convertir los datos a formato panel
pdata <- pdata.frame(panel_data, index = c("person_id", "time"))
```

### a) Estimación de primeras diferencias

```{r}
# Estimación de primeras diferencias
model_diff_3 <- plm(health_gen_bin ~ treatment, data = pdata, model = "fd")
summary(model_diff_3)
```

El intercepto representa la diferencia promedio en la salud general autoreportada entre los tres periodos. Hay un aumento de 2.33% en la probabilidad de reportar buena salud general.

### b) Tabla 3x2

```{r}
table_3x2 <- panel_data %>%
  group_by(time, treatment) %>%
  summarize(mean_health = mean(health_gen_bin, na.rm = TRUE), .groups = 'drop')
(table_3x2)
```

1.  DID 6 meses:

```{=tex}
\begin{align*}
\text{DID}_{6m} &= (\text{mean\_health}_{6m, \text{treatment}} - \text{mean\_health}_{0m, \text{treatment}}) \\
&- (\text{mean\_health}_{6m, \text{control}} - \text{mean\_health}_{0m, \text{control}})
\end{align*}
```
```{=tex}
\begin{align*}
\text{DID}_{6m} &= (0.407 - 0.369) \\
&- (0.465 - 0.393) \\
&= 0.038 - 0.072 \\
&= -0.034
\end{align*}
```
2.  DID 12 meses:

```{=tex}
\begin{align*}
\text{DID}_{12m} &= (\text{mean\_health}_{12m, \text{treatment}} - \text{mean\_health}_{0m, \text{treatment}}) \\
&- (\text{mean\_health}_{12m, \text{control}} - \text{mean\_health}_{0m, \text{control}})
\end{align*}
```
```{=tex}
\begin{align*}
\text{DID}_{12m} &= (0.389 - 0.369) \\
&- (0.439 - 0.393) \\
&= 0.020 - 0.046 \\
&= -0.026
\end{align*}
```
### c) MCO

```{r}
ppanel_data <- panel_data %>%
  arrange(person_id, time) %>%
  group_by(person_id) %>%
  mutate(diff_health_gen_bin = health_gen_bin - lag(health_gen_bin)) %>%
  filter(!is.na(diff_health_gen_bin))

# Estimar el modelo de MCO para diferencias en diferencias
#model_diff_mco <- lm(diff_health_gen_bin ~ treatment, data = panel_data)

# Resultados del modelo
#summary(model_diff_mco)
```
